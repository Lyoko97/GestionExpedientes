@model IEnumerable<dynamic>

@{
    ViewData["Title"] = "Promedio de Notas por Alumno";
}

<h1>@ViewData["Title"]</h1>

<div class="alert alert-info" role="alert">
    <strong> Reporte Estadístico</strong> - Visualización del rendimiento académico de los estudiantes
</div>

@if (!Model.Any())
{
    <div class="alert alert-warning">
        No hay expedientes registrados para calcular promedios.
    </div>
}
else
{
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">Total de Alumnos</h5>
                    <h2>@Model.Count()</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">Promedio General</h5>
                    <h2>@(Model.Any() ? ((decimal)Model.Average(m => (double)m.Promedio)).ToString("F2") : "0.00")</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">Mejor Promedio</h5>
                    <h2>@(Model.Any() ? ((decimal)Model.Max(m => (double)m.Promedio)).ToString("F2") : "0.00")</h2><h2>@Model.Max(m => m.Promedio).ToString("F2")</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-dark text-white">
            <h4> Detalle por Alumno</h4>
        </div>
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Posición</th>
                        <th>Alumno</th>
                        <th>Promedio</th>
                        <th>Materias Cursadas</th>
                        <th>Nota Máxima</th>
                        <th>Nota Mínima</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int posicion = 1;
                    }
                    @foreach (var item in Model)
                    {
                        string estadoClass = "";
                        string estadoTexto = "";

                        if (item.Promedio >= 9)
                        {
                            estadoClass = "success";
                            estadoTexto = "Excelente";
                        }
                        else if (item.Promedio >= 7)
                        {
                            estadoClass = "primary";
                            estadoTexto = "Bueno";
                        }
                        else if (item.Promedio >= 6)
                        {
                            estadoClass = "warning";
                            estadoTexto = "Regular";
                        }
                        else
                        {
                            estadoClass = "danger";
                            estadoTexto = "Necesita Mejorar";
                        }

                        <tr>
                            <td>
                                @if (posicion == 1)
                                {
                                    <span class="badge bg-warning text-dark"> @posicion</span>
                                }
                                else if (posicion == 2)
                                {
                                    <span class="badge bg-secondary"> @posicion</span>
                                }
                                else if (posicion == 3)
                                {
                                    <span class="badge bg-warning"> @posicion</span>
                                }
                                else
                                {
                                    <span class="badge bg-dark">@posicion</span>
                                }
                            </td>
                            <td><strong>@item.NombreCompleto</strong></td>
                            <td><span class="badge bg-@estadoClass fs-6">@item.Promedio.ToString("F2")</span></td>
                            <td>@item.CantidadMaterias</td>
                            <td>@item.NotaMaxima.ToString("F2")</td>
                            <td>@item.NotaMinima.ToString("F2")</td>
                            <td><span class="badge bg-@estadoClass">@estadoTexto</span></td>
                        </tr>
                        posicion++;
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Gráfica simple con barras CSS -->
    <div class="card mt-4">
        <div class="card-header bg-dark text-white">
            <h4>📊 Visualización de Promedios</h4>
        </div>
        <div class="card-body">
            @foreach (var item in Model)
            {
                var porcentaje = Convert.ToDouble(item.Promedio) * 10;
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span><strong>@item.NombreCompleto</strong></span>
                        <span class="badge bg-primary">@item.Promedio.ToString("F2")</span>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar bg-success" role="progressbar"
                             style="width: @porcentaje%"
                             aria-valuenow="@item.Promedio"
                             aria-valuemin="0"
                             aria-valuemax="10">
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}

<div class="mt-3">
    <a asp-action="Index" class="btn btn-secondary">Volver a Expedientes</a>
</div>