@model IEnumerable<dynamic>

@{
    ViewData["Title"] = "Promedio de Notas por Alumno";
}

<h1>@ViewData["Title"]</h1>

<div class="alert alert-info" role="alert">
    <strong> Reporte Estadístico</strong> - Visualización del rendimiento académico de los estudiantes
</div>

@if (!Model.Any())
{
    <div class="alert alert-warning">
        No hay expedientes registrados para calcular promedios.
    </div>
}
else
{
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">Total de Alumnos</h5>
                    <h2>@Model.Count()</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">Promedio General</h5>
                    <h2>@(Model.Any() ? ((decimal)Model.Average(m => (double)m.Promedio)).ToString("F2") : "0.00")</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">Mejor Promedio</h5>
                    <h2>@(Model.Any() ? ((decimal)Model.Max(m => (double)m.Promedio)).ToString("F2") : "0.00")</h2><h2>@Model.Max(m => m.Promedio).ToString("F2")</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-dark text-white">
            <h4> Detalle por Alumno</h4>
        </div>
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Posición</th>
                        <th>Alumno</th>
                        <th>Promedio</th>
                        <th>Materias Cursadas</th>
                        <th>Nota Máxima</th>
                        <th>Nota Mínima</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int posicion = 1;
                    }
                    @foreach (var item in Model)
                    {
                        string estadoClass = "";
                        string estadoTexto = "";

                        if (item.Promedio >= 9)
                        {
                            estadoClass = "success";
                            estadoTexto = "Excelente";
                        }
                        else if (item.Promedio >= 7)
                        {
                            estadoClass = "primary";
                            estadoTexto = "Bueno";
                        }
                        else if (item.Promedio >= 6)
                        {
                            estadoClass = "warning";
                            estadoTexto = "Regular";
                        }
                        else
                        {
                            estadoClass = "danger";
                            estadoTexto = "Necesita Mejorar";
                        }

                        <tr>
                            <td>
                                @if (posicion == 1)
                                {
                                    <span class="badge bg-warning text-dark"> @posicion</span>
                                }
                                else if (posicion == 2)
                                {
                                    <span class="badge bg-secondary"> @posicion</span>
                                }
                                else if (posicion == 3)
                                {
                                    <span class="badge bg-warning"> @posicion</span>
                                }
                                else
                                {
                                    <span class="badge bg-dark">@posicion</span>
                                }
                            </td>
                            <td><strong>@item.NombreCompleto</strong></td>
                            <td><span class="badge bg-@estadoClass fs-6">@item.Promedio.ToString("F2")</span></td>
                            <td>@item.CantidadMaterias</td>
                            <td>@item.NotaMaxima.ToString("F2")</td>
                            <td>@item.NotaMinima.ToString("F2")</td>
                            <td><span class="badge bg-@estadoClass">@estadoTexto</span></td>
                        </tr>
                        posicion++;
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Gráfica simple con barras CSS -->
    <div class="card mt-4">
        <div class="card-header bg-dark text-white">
            <h4> Visualización de Promedios</h4>
        </div>
        <div class="card-body">
            @foreach (var item in Model)
            {
                var porcentaje = Convert.ToDouble(item.Promedio) * 10;
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span><strong>@item.NombreCompleto</strong></span>
                        <span class="badge bg-primary">@item.Promedio.ToString("F2")</span>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar bg-success" role="progressbar"
                             style="width: @porcentaje%"
                             aria-valuenow="@item.Promedio"
                             aria-valuemin="0"
                             aria-valuemax="10">
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}

<!-- Sección de Gráficas Estadísticas -->
<div class="row mt-4">
    <!-- Gráfica 1: Barras - Promedio por Alumno -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5> Promedio por Alumno</h5>
            </div>
            <div class="card-body">
                <canvas id="chartPromedios"></canvas>
            </div>
        </div>
    </div>

    <!-- Gráfica 2: Dona - Distribución de Rendimiento -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5> Distribución de Rendimiento</h5>
            </div>
            <div class="card-body">
                <canvas id="chartDistribucion"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Gráfica 3: Comparativa de Notas Máximas y Mínimas -->
<div class="card mt-4 mb-4">
    <div class="card-header bg-dark text-white">
        <h5> Comparativa: Notas Máximas vs Mínimas por Alumno</h5>
    </div>
    <div class="card-body">
        <canvas id="chartComparativa"></canvas>
    </div>
</div>

<div class="mt-3">
    <a asp-action="Index" class="btn btn-secondary">Volver a Expedientes</a>
</div>

@section Scripts {
    <!-- Librería Chart.js desde CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        // Preparar datos desde el modelo
        var alumnos = [@Html.Raw(string.Join(",", Model.Select(m => $"\"{m.NombreCompleto}\"")))];
        var promedios = [@Html.Raw(string.Join(",", Model.Select(m => m.Promedio)))];
        var notasMaximas = [@Html.Raw(string.Join(",", Model.Select(m => m.NotaMaxima)))];
        var notasMinimas = [@Html.Raw(string.Join(",", Model.Select(m => m.NotaMinima)))];

        // Colores dinámicos basados en el promedio
        var coloresBarra = promedios.map(function(promedio) {
            if (promedio >= 9) return 'rgba(40, 167, 69, 0.8)';      // Verde - Excelente
            else if (promedio >= 7) return 'rgba(0, 123, 255, 0.8)'; // Azul - Bueno
            else if (promedio >= 6) return 'rgba(255, 193, 7, 0.8)'; // Amarillo - Regular
            else return 'rgba(220, 53, 69, 0.8)';                     // Rojo - Necesita mejorar
        });

        // GRÁFICA 1: Barras - Promedio por Alumno
        var ctx1 = document.getElementById('chartPromedios').getContext('2d');
        var chartPromedios = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: alumnos,
                datasets: [{
                    label: 'Promedio',
                    data: promedios,
                    backgroundColor: coloresBarra,
                    borderColor: coloresBarra.map(color => color.replace('0.8', '1')),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Calificaciones por Alumno'
                    }
                }
            }
        });

        // GRÁFICA 2: Dona - Distribución de Rendimiento
        var excelentes = promedios.filter(p => p >= 9).length;
        var buenos = promedios.filter(p => p >= 7 && p < 9).length;
        var regulares = promedios.filter(p => p >= 6 && p < 7).length;
        var necesitaMejorar = promedios.filter(p => p < 6).length;

        var ctx2 = document.getElementById('chartDistribucion').getContext('2d');
        var chartDistribucion = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Excelente (9-10)', 'Bueno (7-8.9)', 'Regular (6-6.9)', 'Necesita Mejorar (<6)'],
                datasets: [{
                    data: [excelentes, buenos, regulares, necesitaMejorar],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',   // Verde
                        'rgba(0, 123, 255, 0.8)',   // Azul
                        'rgba(255, 193, 7, 0.8)',   // Amarillo
                        'rgba(220, 53, 69, 0.8)'    // Rojo
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(0, 123, 255, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(220, 53, 69, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Clasificación del Rendimiento Académico'
                    }
                }
            }
        });

        // GRÁFICA 3: Líneas - Comparativa Máximas vs Mínimas
        var ctx3 = document.getElementById('chartComparativa').getContext('2d');
        var chartComparativa = new Chart(ctx3, {
            type: 'line',
            data: {
                labels: alumnos,
                datasets: [
                    {
                        label: 'Nota Máxima',
                        data: notasMaximas,
                        borderColor: 'rgba(40, 167, 69, 1)',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Promedio',
                        data: promedios,
                        borderColor: 'rgba(0, 123, 255, 1)',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Nota Mínima',
                        data: notasMinimas,
                        borderColor: 'rgba(220, 53, 69, 1)',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'Rango de Notas por Estudiante'
                    }
                }
            }
        });
    </script>
}